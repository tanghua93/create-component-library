#!/usr/bin/env node

const inquirer = require('inquirer');
const download = require('download-git-repo');
const argv = require('yargs').argv;
const ora = require('ora');
const fs = require('fs');
const spinner = ora('downloading template ...');
const questions = [{
    type: 'input',
    name: 'projectName',
    message: 'projectNameï¼š',
    default: process.argv[2] ? process.argv[2] :'library-skeleton',
    validate (val) {
        if(!val) {
            return 'è¯·è¾“å…¥æ–‡ä»¶å';
        }
        if(fs.existsSync(val)) {
            return 'æ–‡ä»¶å·²å­˜åœ¨';
        }else {
            return true;
        };
    }
},{
    type: 'input',
    name: 'version',
    message: 'verson(1.0.0)ï¼š',
    default: '1.0.0',
    validate (val) {
        return true;
    }
},{
    type: 'input',
        name: 'repository',
        message: 'smilelabi/library-skeleton',
        default: 'direct:https://github.com/smilelabi/library-skeleton.git'
}];

const editFile = function({ version, projectName }) {
    fs.readFile(`${process.cwd()}/${projectName}/package.json`, (err, data) => {
        if (err) throw err;
        let _data = JSON.parse(data.toString())
        _data.name = projectName
        _data.version = version
        let str = JSON.stringify(_data, null, 4);
        fs.writeFile(`${process.cwd()}/${projectName}/package.json`, str, function (err) {
            if (err) throw err;
        })
        spinner.succeed();
    });
};

/**
 * @description: ä¸‹è½½æ¨¡æ¿
 * @param {type} 
 * @return: 
 */
const downloadTemplate = function({ repository, version, projectName }) {
    download(repository, projectName, { clone: true }, function (err) {
        console.log(err ? 'æ¨¡æ¿åŠ è½½é”™è¯¯' : 'æ¨¡æ¿åˆ›å»ºæˆðŸŽ‰ðŸŽ‰ðŸŽ‰');
        if(err !== 'Error') {
            editFile({ version, projectName });
        }
    })
};

inquirer
    .prompt(questions)
    .then(answers => {
        const version = answers.version;
        const projectName = answers.projectName;
        const repository = answers.repository ? answers.repository :'https://github.com/smilelabi/library-skeleton.git';
        console.log(repository)
        spinner.start();
        spinner.color = 'green';
        downloadTemplate({ repository, version, projectName });
    });


    

